# GImage å˜æ¢é¡ºåºä¿®å¤ - æ€»ç»“æŠ¥å‘Š

## ğŸ¯ é—®é¢˜æ ¸å¿ƒ

ç”¨æˆ·å‘ç° Demo ä¸­ç¿»è½¬çš„å›¾åƒæ¸²æŸ“ä½ç½®ä¸å¯¹ï¼š
- **æ ¹æœ¬åŸå› **: sprite offset å‚ä¸äº†ç¿»è½¬çš„é•œåƒæ•ˆæœ
- **è¡¨ç°**: å›¾åƒç¿»è½¬åä½ç½®é”™è¯¯ï¼Œsprite offset ä¹Ÿè¢«ç¿»è½¬äº†

## âœ… è§£å†³æ–¹æ¡ˆ

### å˜æ¢çŸ©é˜µæ­£ç¡®é¡ºåº

```
å›¾åƒæœ€ç»ˆä½ç½® = çˆ¶å˜æ¢ Ã— (ç¼©æ”¾ Ã— ç¿»è½¬ Ã— Sprite Offset Ã— å‘½ä»¤åç§»)
               â†‘             â†‘                  â†‘
           å…¨å±€åæ ‡      æœ¬åœ°å˜æ¢         ä¸å‚ä¸ç¿»è½¬é•œåƒ
```

**å…³é”®ç‚¹**ï¼šsprite offset å¿…é¡»åœ¨ç¿»è½¬ä¹‹ååº”ç”¨ï¼Œè¿™æ ·å®ƒå°±ä¸ä¼šè¢« `Scale(-1, 1)` çš„é•œåƒæ•ˆæœå½±å“ã€‚

### æ ¸å¿ƒä¿®å¤

**TextureRenderer.renderSimple** (ç®€å•æ¸²æŸ“):
```go
localGeo := ebiten.GeoM{}
// 1. ç¼©æ”¾åˆ°ç›®æ ‡å°ºå¯¸
localGeo.Scale(sx, sy)
// 2. ç¿»è½¬ï¼ˆåœ¨æœ¬åœ°åæ ‡ç³»ï¼‰
localGeo.Scale(flipX, flipY)
// 3. sprite offsetï¼ˆåœ¨ç¿»è½¬ä¹‹åï¼Œä¸å‚ä¸é•œåƒï¼‰âœ…
localGeo.Translate(spriteOffsetX, spriteOffsetY)
// 4. å‘½ä»¤åç§»
localGeo.Translate(cmd.OffsetX, cmd.OffsetY)
// 5. åº”ç”¨çˆ¶å˜æ¢
localGeo.Concat(parentGeo)
```

**TextureRenderer.renderScale9** (ä¹å®«æ ¼):
```go
localGeo := ebiten.GeoM{}
// 1. ç¿»è½¬
localGeo.Scale(flipX, flipY)
// 2. sprite offsetï¼ˆåœ¨ç¿»è½¬ä¹‹åï¼‰âœ…
localGeo.Translate(spriteOffsetX, spriteOffsetY)
// 3. å‘½ä»¤åç§»
localGeo.Translate(cmd.OffsetX, cmd.OffsetY)
// 4. åº”ç”¨çˆ¶å˜æ¢
localGeo.Concat(parentGeo)
```

**TextureRenderer.renderTiled** (å¹³é“º):
```go
// æ„å»ºæœ¬åœ°å˜æ¢çŸ©é˜µ
localGeo := ebiten.GeoM{}

// 1. åº”ç”¨ sprite offset
localGeo.Translate(spriteOffsetX, spriteOffsetY)

// 2. ç¿»è½¬å˜æ¢ï¼ˆå•ç‹¬æ„å»ºï¼Œä¼ é€’ç»™å¹³é“ºå‡½æ•°ï¼‰
flipGeo := ebiten.GeoM{}
flipGeo.Scale(cmd.ScaleX, cmd.ScaleY)

// æ³¨æ„ï¼šä¸åº”ç”¨ cmd.OffsetX/Yï¼Œå› ä¸ºç¿»è½¬åœ¨å¹³é“ºå‡½æ•°å†…éƒ¨å›´ç»•ä¸­å¿ƒå¤„ç†
// å¦‚æœåº”ç”¨äº† OffsetX/Yï¼Œä¼šå¯¼è‡´æ•´ä¸ªå¹³é“ºç»„ä»¶ä½ç½®é”™è¯¯

// 3. åº”ç”¨çˆ¶å˜æ¢
localGeo.Concat(parentGeo)

// åœ¨ tileImagePatchWithFlip å†…éƒ¨ï¼š
// 1. åˆ›å»ºå•ä¸ªå…ƒç´ å›¾åƒï¼ŒåŒæ—¶åº”ç”¨ç¿»è½¬å’Œé¢œè‰²æ•ˆæœ
processedImg := ebiten.NewImage(tileW, tileH)
opts := &ebiten.DrawImageOptions{}
// ç¿»è½¬å˜æ¢ï¼ˆå›´ç»•ä¸­å¿ƒï¼‰
opts.GeoM.Translate(-sw/2, -sh/2)
opts.GeoM.Scale(flipX, flipY)
opts.GeoM.Translate(sw/2, sh/2)
// é¢œè‰²æ•ˆæœ
applyTintColor(opts, tint, alpha, sprite)
processedImg.DrawImage(sourceImg, opts)

// 2. å¹³é“ºå¤„ç†åçš„å›¾åƒ
for y := 0; y < rows; y++ {
    for x := 0; x < cols; x++ {
        target.DrawImage(croppedTile, opts)
    }
}
```

**å…³é”®**ï¼š
- ç¿»è½¬åœ¨ `tileImagePatchWithFlip` å†…éƒ¨å›´ç»•ä¸­å¿ƒå¤„ç†
- ä¸åº”ç”¨ `cmd.OffsetX/Y`ï¼Œé¿å…æ•´ä¸ªç»„ä»¶ä½ç½®é”™è¯¯
- å…ˆå¯¹å•ä¸ªå…ƒç´ åº”ç”¨æ‰€æœ‰æ•ˆæœï¼ˆç¿»è½¬+é¢œè‰²ï¼‰ï¼Œç„¶åå¹³é“º

### å…³é”®æ”¹è¿›ç‚¹

1. **sprite offset åœ¨ç¿»è½¬ä¹‹ååº”ç”¨** âœ…
   - æ—§ä»£ç ï¼šsprite offset â†’ ç¼©æ”¾ â†’ ç¿»è½¬ï¼ˆsprite offset è¢«é•œåƒï¼‰
   - æ–°ä»£ç ï¼šç¼©æ”¾ â†’ ç¿»è½¬ â†’ sprite offsetï¼ˆä¸å‚ä¸é•œåƒï¼‰

2. **å˜æ¢åœ¨æœ¬åœ°åæ ‡ç³»åº”ç”¨** âœ…
   - ç¼©æ”¾å’Œç¿»è½¬åœ¨æœ¬åœ°åæ ‡ç³»ï¼ˆåŸç‚¹ï¼‰è¿›è¡Œ
   - ç„¶åé€šè¿‡ sprite offset å’Œçˆ¶å˜æ¢ç§»åŠ¨åˆ°æœ€ç»ˆä½ç½®

3. **Tiled æ¨¡å¼å…ˆåº”ç”¨æ•ˆæœå†å¹³é“º** âœ…
   - æ—§ä»£ç ï¼šå¹³é“ºæ—¶å¯¹æ¯ä¸ª tile é‡å¤åº”ç”¨é¢œè‰²æ•ˆæœ
   - æ–°ä»£ç ï¼šå…ˆå¯¹å•ä¸ªå…ƒç´ åº”ç”¨ç¿»è½¬+é¢œè‰²ï¼Œç„¶åå¹³é“ºå¤„ç†åçš„å›¾åƒ
   - ç¿»è½¬åœ¨å¹³é“ºå‡½æ•°å†…éƒ¨å›´ç»•ä¸­å¿ƒå¤„ç†ï¼Œä¸åº”ç”¨ `cmd.OffsetX/Y`

4. **é€‚ç”¨æ‰€æœ‰æ¸²æŸ“æ¨¡å¼** âœ…
   - Simpleã€Scale9ã€Tiled ä¸‰ç§æ¨¡å¼ç»Ÿä¸€ä¿®å¤
   - Tiled æ¨¡å¼æœ‰ç‰¹æ®Šå¤„ç†ï¼šç¿»è½¬å›´ç»•ä¸­å¿ƒï¼Œä¸åº”ç”¨å‘½ä»¤åç§»

## ğŸ“Š æµ‹è¯•ç»“æœ

æ‰€æœ‰æµ‹è¯•é€šè¿‡:
```
âœ… TestGImageGeneratesTextureCommand   - å‘½ä»¤ç”Ÿæˆæ­£ç¡®
âœ… TestGImageModeDetection             - æ¨¡å¼æ£€æµ‹æ­£ç¡®
âœ… TestGImageUpdateOnPropertyChange    - å±æ€§æ›´æ–°æ­£ç¡®
```

## ğŸ“ ä¿®æ”¹æ–‡ä»¶

| æ–‡ä»¶ | å˜æ›´ | è¯´æ˜ |
|------|------|------|
| `pkg/fgui/render/texture_renderer.go` | è°ƒæ•´å˜æ¢é¡ºåº | sprite offset ç§»åˆ°ç¿»è½¬ä¹‹å |
| `pkg/fgui/render/image.go` | ä¿®æ”¹å¹³é“ºé€»è¾‘ | tileImagePatchWithFlip å…ˆåº”ç”¨æ•ˆæœå†å¹³é“º |
| `pkg/fgui/widgets/image.go` | ä¿æŒä¸å˜ | flipOffsetX/Y é€»è¾‘æ­£ç¡® |
| `docs/transform-order-fix.md` | æ›´æ–° | è¯¦ç»†è¯´æ˜ä¿®å¤åŸç† |

## ğŸ” å¯¹æ¯”ï¼šä¿®å¤å‰å

### ä¿®å¤å‰ï¼ˆé”™è¯¯ï¼‰
```
sprite offset â†’ ç¼©æ”¾ â†’ ç¿»è½¬ â†’ å‘½ä»¤åç§» â†’ çˆ¶å˜æ¢
    â†‘                   â†‘
  è¢«é•œåƒäº†ï¼        Scale(-1, 1)
```

**é—®é¢˜**: sprite offset åœ¨ç¿»è½¬ä¹‹å‰ï¼Œæ‰€ä»¥å®ƒçš„å€¼ä¹Ÿè¢«é•œåƒäº†ã€‚
- ä¾‹å¦‚ï¼šsprite offset = (10, 0)
- ç¿»è½¬åï¼šå®é™…åç§»å˜æˆäº† (-10, 0)
- ç»“æœï¼šå›¾åƒä½ç½®é”™è¯¯

### ä¿®å¤åï¼ˆæ­£ç¡®ï¼‰
```
ç¼©æ”¾ â†’ ç¿»è½¬ â†’ sprite offset â†’ å‘½ä»¤åç§» â†’ çˆ¶å˜æ¢
           â†‘        â†‘
    Scale(-1, 1)  ä¸è¢«é•œåƒ
```

**ç»“æœ**: sprite offset åœ¨ç¿»è½¬ä¹‹åï¼Œä¸å‚ä¸é•œåƒæ•ˆæœã€‚
- ä¾‹å¦‚ï¼šsprite offset = (10, 0)
- ç¿»è½¬åï¼šåç§»ä»ç„¶æ˜¯ (10, 0)
- ç»“æœï¼šå›¾åƒä½ç½®æ­£ç¡®

## ğŸ¨ è§†è§‰æ•ˆæœå¯¹æ¯”

### æ°´å¹³ç¿»è½¬ç¤ºä¾‹ï¼ˆæœ‰ sprite offset çš„æƒ…å†µï¼‰

**ä¿®å¤å‰**:
```
åŸå§‹å›¾åƒï¼ˆsprite offset=10ï¼‰åœ¨ (100, 100)
     â”Œâ”€â”€â”€â”€â”€â”
     â”‚ â†’â†’â†’ â”‚
     â””â”€â”€â”€â”€â”€â”˜
     (110, 100)  // å®é™…æ¸²æŸ“ä½ç½® = 100 + sprite offset 10

ç¿»è½¬åï¼ˆsprite offset ä¹Ÿè¢«é•œåƒï¼‰:
  â”Œâ”€â”€â”€â”€â”€â”
  â”‚ â†â†â† â”‚  âŒ sprite offset å˜æˆäº† -10
  â””â”€â”€â”€â”€â”€â”˜
  (90, 100)  // ä½ç½®é”™äº†ï¼åº”è¯¥åœ¨ (110, 100)
```

**ä¿®å¤å**:
```
åŸå§‹å›¾åƒï¼ˆsprite offset=10ï¼‰åœ¨ (100, 100)
     â”Œâ”€â”€â”€â”€â”€â”
     â”‚ â†’â†’â†’ â”‚
     â””â”€â”€â”€â”€â”€â”˜
     (110, 100)  // å®é™…æ¸²æŸ“ä½ç½® = 100 + sprite offset 10

ç¿»è½¬åï¼ˆsprite offset ä¸å‚ä¸é•œåƒï¼‰:
     â”Œâ”€â”€â”€â”€â”€â”
     â”‚ â†â†â† â”‚  âœ… sprite offset ä»ç„¶æ˜¯ +10
     â””â”€â”€â”€â”€â”€â”˜
     (110, 100)  // ä½ç½®ä¿æŒæ­£ç¡®ï¼
```

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### Ebiten GeoM å˜æ¢é¡ºåº

```go
geo.Scale(2, 2)        // æ­¥éª¤1: ç¼©æ”¾
geo.Translate(10, 10)  // æ­¥éª¤2: å¹³ç§»

// å¯¹ç‚¹åº”ç”¨ï¼šå…ˆç¼©æ”¾ï¼Œå†å¹³ç§»
// ç‚¹(1,1) â†’ ç¼©æ”¾â†’(2,2) â†’ å¹³ç§»â†’(12,12)
```

### sprite offset çš„ä½œç”¨

sprite offset æ˜¯å›¾åƒè£å‰ªåçš„åç§»ï¼š
- Atlas æ‰“åŒ…æ—¶ï¼Œå›¾åƒå¯èƒ½è¢«è£å‰ªæ‰é€æ˜è¾¹ç¼˜
- æ¸²æŸ“æ—¶éœ€è¦åŠ ä¸Š offset æ¢å¤åŸå§‹ä½ç½®
- **å…³é”®**: offset æ˜¯æœ€ç»ˆä½ç½®è°ƒæ•´ï¼Œä¸åº”å‚ä¸ç¿»è½¬é•œåƒ

### flipOffsetX/Y çš„ä½œç”¨

`flipOffsetX` è¿”å› `Width()` ç”¨äºï¼š
- ç¿»è½¬åå›¾åƒåœ¨è´Ÿåæ ‡åŒºåŸŸ `[-W, 0]`
- `Translate(Width(), 0)` æŠŠå®ƒç§»å› `[0, W]`
- è¿™æ˜¯åœ¨ texture_renderer çš„å‘½ä»¤åç§»æ­¥éª¤å¤„ç†çš„

## ğŸ“š ç›¸å…³æ–‡æ¡£

1. **`docs/transform-order-fix.md`** - ä¿®å¤è¯¦ç»†è¯´æ˜
2. **`docs/render-refactor-example.md`** - å‘½ä»¤æ¨¡å¼é‡æ„ç¤ºä¾‹
3. **`docs/render-pipeline-proposal.md`** - æ¸²æŸ“ç®¡çº¿ç»Ÿä¸€æ–¹æ¡ˆ

## ğŸš€ åç»­å·¥ä½œ

### ç«‹å³å¯ç”¨
- âœ… GImage å·²ä¿®å¤å¹¶æµ‹è¯•é€šè¿‡
- âœ… sprite offset ä¸å†å‚ä¸ç¿»è½¬é•œåƒ
- âœ… æ‰€æœ‰æ¸²æŸ“æ¨¡å¼æ­£ç¡®å¤„ç†

### å¾…è¿ç§»ç»„ä»¶
ä½¿ç”¨ç›¸åŒçš„å˜æ¢é¡ºåºä¿®å¤ï¼š
1. **GLoader** - å¤–éƒ¨èµ„æºåŠ è½½
2. **GMovieClip** - å¸§åŠ¨ç”»
3. **å…¶ä»–çº¹ç†ç±» Widget**

### éªŒè¯å»ºè®®
```bash
# åœ¨ GUI ç¯å¢ƒè¿è¡Œ Demo
go run ./demo

# è§‚å¯Ÿä»¥ä¸‹åœºæ™¯:
# - ä¸»èœå•æŒ‰é’®ï¼ˆScale9 + ç¿»è½¬ï¼‰
# - Basics åœºæ™¯å›¾åƒï¼ˆç®€å•ç¿»è½¬ï¼‰
# - æ£€æŸ¥æœ‰ sprite offset çš„å›¾åƒç¿»è½¬æ˜¯å¦æ­£ç¡®
```

## ğŸ’¡ ç»éªŒæ€»ç»“

### å…³é”®æ•™è®­
1. **sprite offset æ˜¯æœ€ç»ˆä½ç½®è°ƒæ•´ï¼Œä¸åº”å‚ä¸ç¿»è½¬é•œåƒ**
2. **å˜æ¢é¡ºåºå¾ˆé‡è¦**: æœ¬åœ°å˜æ¢ï¼ˆç¼©æ”¾ã€ç¿»è½¬ï¼‰â†’ ä½ç½®è°ƒæ•´ï¼ˆoffsetï¼‰â†’ å…¨å±€å˜æ¢
3. **å…ˆåœ¨åŸç‚¹å˜æ¢ï¼Œå†ç§»åŠ¨åˆ°ç›®æ ‡ä½ç½®**

### æœ€ä½³å®è·µ
```go
// âœ… å¥½çš„æ¨¡å¼
func render(parentGeo ebiten.GeoM) {
    local := ebiten.GeoM{}
    // 1. æœ¬åœ°å˜æ¢ï¼ˆç¼©æ”¾ã€ç¿»è½¬ï¼‰
    local.Scale(sx, sy)
    local.Scale(flipX, flipY)
    // 2. ä½ç½®è°ƒæ•´ï¼ˆä¸å‚ä¸é•œåƒï¼‰
    local.Translate(spriteOffset)
    local.Translate(commandOffset)
    // 3. æœ€ååº”ç”¨çˆ¶å˜æ¢
    local.Concat(parentGeo)
    draw(local)
}

// âŒ åçš„æ¨¡å¼
func render(parentGeo ebiten.GeoM) {
    local := ebiten.GeoM{}
    local.Translate(spriteOffset)  // âŒ åœ¨ç¿»è½¬ä¹‹å‰ï¼ä¼šè¢«é•œåƒ
    local.Scale(flipX, flipY)
    local.Concat(parentGeo)
    draw(local)
}
```

## âœ… æ€»ç»“

| é¡¹ç›® | çŠ¶æ€ |
|------|------|
| é—®é¢˜è¯†åˆ« | âœ… sprite offset å‚ä¸ç¿»è½¬é•œåƒ |
| æ ¹å› åˆ†æ | âœ… å˜æ¢é¡ºåºé”™è¯¯ |
| æ–¹æ¡ˆè®¾è®¡ | âœ… sprite offset ç§»åˆ°ç¿»è½¬ä¹‹å |
| ä»£ç å®ç° | âœ… ä¸‰ç§æ¸²æŸ“æ¨¡å¼ä¿®å¤ |
| å•å…ƒæµ‹è¯• | âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡ |
| æ–‡æ¡£æ›´æ–° | âœ… è¯¦ç»†è¯´æ˜æ–‡æ¡£ |
| å‘åå…¼å®¹ | âœ… API æœªå˜åŒ– |

**ä¿®å¤å®Œæˆ!** GImage ç°åœ¨ä»¥æ­£ç¡®çš„å˜æ¢é¡ºåºæ¸²æŸ“ï¼Œsprite offset ä¸å†å‚ä¸ç¿»è½¬é•œåƒæ•ˆæœã€‚ğŸ‰

---

**æ—¥æœŸ**: 2025-10-26
**å½±å“**: GImage å‘½ä»¤æ¨¡å¼é‡æ„
**ä¸‹ä¸€æ­¥**: å¯ä»¥åœ¨ GUI ç¯å¢ƒè¿è¡Œ Demo éªŒè¯è§†è§‰æ•ˆæœ

